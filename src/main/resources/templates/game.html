<!DOCTYPE html>
<html lang="en">
<head>
    <th:block th:replace="fragments/head :: header" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventurer's List: Nombre de la Partida</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Include the meta tag for CSRF token -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<link rel="stylesheet" href="../static/game.css" th:href="@{/css/game.css}">
<link rel="stylesheet" href="../static/main.css" th:href="@{/css/main.css}">
<body class="background">
    <div class="missions-table" style="width: 90%; margin-left: 5%; margin-top: 5%;">
        <div class="game_container">
            <div id="viewButtons">
                <div th:replace="~{fragments/missionsButtons.html :: missionsButtons}">
                    no funcó :(
                </div>
            </div>
            <div class="image_container">
                <img src="img/gatoque.jpg"/>
            </div>
            <div class="gamedata"><ul class="list">
                <li><h1 th:text="${game.name}">Title</h1></li>
                <li><h2 th:text="${game.gamesystem}">System</h2></li>
                <li><h3 th:text="${game.meeting}">Schedules</h3></li>
            </ul>
        </div>
        
            
            <div class="genericlist">
                Director de Juego:
                <ul class="list">
                    <li th:text="${game.owner.username}">Usuario</li>
                </ul>
                Jugadores:
                <ul class="list" >
                
                    <li th:each="user : ${users}">
                        <div th:text="user">user</div>
                    </li>
                 
                    
                </ul>
            </div>
            <div class="description" th:text="${game.description}">
                desc
            </div>
            <div class="location">
                Dónde se juega
                <ul class="genericlist">
                    <div class="image_container">
                        <img src="img/gatoque.jpg"/>
                    </div>
                </ul>
                <!-- Esto si el usuario es jugador de la partida, se saca desde th -->
                <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">Link a la partida</a>
            </div>
            <div class="button_container">
                <ul class="list">
                    <li>
                        <button id="joinLeaveButton" onclick="joinOrLeaveGame()">Unirte a la partida</button>
                    </li>
                </ul>
            </div>
            
            
        </div>
        <div class="messageBoard">
            <ul>
                <li th:each="message : ${messageLog}">
                    <div th:replace="~{fragments/message.html :: div(message=${message})}"></div>
                </li>
            </ul> 
            <div id="sendMessageForm">
                <input type="text" id="message" name="message"/>
                <button id="sendMessageButton">Enviar</button>
            </div>
        </div>
    </div>

    <script th:src="@{/js/stomp.js}" src="js/stomp.js"></script>
    <!-- <script th:src="@{/js/game.js}" src="js/game.js"  type="text/javascript"></script> -->
    <script th:src="@{/js/iw.js}" src="js/iw.js"  type="text/javascript"></script>

    <script th:inline="javascript">
        var isJoined = /*[[${userIsJoined}]]*/ false;
        var gameId = /*[[${game.id}]]*/ '';
        var parsedGameId = parseInt(gameId);

        function connectWebsocket() {
            if (isJoined) {
                ws.subscribe("/game/"+parsedGameId+"/queue/updates")
            }
        }
        document.addEventListener("DOMContentLoaded", () => {
            setTimeout(connectWebsocket, 1000);
        });

        $(document).ready(function() {
            updateButtonText(isJoined);

            $("#sendMessageButton").click(function() {
                var token = /*[[${_csrf.token}]]*/ '';
                var header = "_csrf";
                var message = $("#message").val();

                $.ajax({
                    type: "POST",
                    url: "/game/sendMessage",
                    data: {
                        gameId: parsedGameId,
                        message: message,
                        [header]: token
                    },
                    success: function(data) {
                        console.log("Message sent successfully");
                        $("#message").val(""); // Clear the textbox
                        // Optionally update the message board with the new message
                    },
                    error: function(xhr, status, error) {
                        console.error("Error sending message: " + xhr.statusText);
                    }
                });
            });
        });

        function joinOrLeaveGame() {
            var gameId = /*[[${game.id}]]*/ '';
            var token = /*[[${_csrf.token}]]*/ '';
            var header = "_csrf";

            var parsedGameId = parseInt(gameId);
            var url = isJoined ? "/game/leave" : "/game/join";
            
            $.ajax({
                type: "POST",
                url: url,
                data: { 
                    gameId: parsedGameId,
                    [header]: token
                },
                success: function(data) {
                    // Handle success
                    isJoined = !isJoined; // Toggle join status
                    updateButtonText(isJoined);
                },
                error: function(xhr, status, error) {
                    // Handle error
                }
            });
            
            if (!isJoined) {
                ws.subscribe("/game/"+parsedGameId+"/queue/updates")
            }
            else {
                ws.stompClient.unsubscribe("/game/"+parsedGameId+"/queue/updates")
            }
        }

        function updateButtonText(isJoined) {
            if (isJoined) {
                $(".messageBoard").show();
                var buttonText = "Salir de la partida";
            }
            else {
                $(".messageBoard").hide();
                var buttonText = "Unirte a la partida";
            }
            $("#joinLeaveButton").text(buttonText);
        }
    </script>
    

</body>

</html>