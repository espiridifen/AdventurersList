<!DOCTYPE html>
<html lang="en">
<head>
    <th:block th:replace="fragments/head :: header" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventurer's List: Nombre de la Partida</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Include the meta tag for CSRF token -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<link rel="stylesheet" href="../static/game.css" th:href="@{/css/game.css}">
<link rel="stylesheet" href="../static/main.css" th:href="@{/css/main.css}">
<link rel="stylesheet" href="../static/message.css" th:href="@{/css/message.css}">
<body class="background">
    <div class="missions-table" style="width: 90%; margin-left: 5%; margin-top: 5%;">
        <div class="game_container">
            <div id="viewButtons">
                <div th:replace="~{fragments/missionsButtons.html :: missionsButtons}">
                    no funcó :(
                </div>
            </div>
            <div class="image_container">
                <img src="img/gatoque.jpg"/>
            </div>
            <div class="gamedata"><ul class="list">
                <li><h1 th:text="${game.name}">Title</h1></li>
                <li><h2 th:text="${game.gamesystem}">System</h2></li>
                <li><h3 th:text="${game.meeting}">Schedules</h3></li>
            </ul>
        </div>
        
            
            <div class="genericlist">
                Director de Juego:
                <ul class="list" style="margin-left: 10px;">
                    <li th:text="${game.owner.username}">Usuario</li>
                </ul>
                Jugadores:
                <ul class="list" style="margin-left: 10px;">
                    <li th:each="user : ${users}">
                        <div th:text="${user}">user</div>
                    </li>
                </ul>
            </div>
            <div class="description" th:text="${game.description}">
                desc
            </div>
            <div class="location">
                Dónde se juega
                <!-- <ul class="genericlist">
                    <div class="image_container">
                        <img src="img/gatoque.jpg"/>
                    </div>
                </ul> -->
                <div class="location" th:text="${game.meeting}">
                    loc
                </div>
                <!-- Esto si el usuario es jugador de la partida, se saca desde th -->
                <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">Link a la partida</a>
            </div>
            <div class="button_container">
                <ul class="list">
                    <li>
                        <button id="joinLeaveButton" onclick="joinOrLeaveGame()">Unirte a la partida</button>
                    </li>
                </ul>
            </div>
            
            
        </div>
        <div class="messageBoard">
            
            <ul>
                <li th:each="message : ${messageLog}" id="messageBoard">
                    <div th:replace="~{fragments/message.html :: div(message=${message})}"></div>
                </li>
            </ul> 
        </div>
        <div id="sendMessageForm">
            <input type="text" id="message" name="message"/>
            <button id="sendMessageButton">Enviar</button>
        </div>
    </div>

    <script th:src="@{/js/stomp.js}" src="js/stomp.js"></script>
    <!-- <script th:src="@{/js/game.js}" src="js/game.js"  type="text/javascript"></script> -->
    <script th:src="@{/js/iw.js}" src="js/iw.js"  type="text/javascript"></script>

    <script th:inline="javascript">
        var isJoined = /*[[${userIsJoined}]]*/ false;
        var gameId = /*[[${game.id}]]*/ '';
        var token = /*[[${_csrf.token}]]*/ '';
        var header = "_csrf";
        var parsedGameId = parseInt(gameId);

        function connectWebsocket() {
            if (isJoined) {
                ws.subscribe("/game/"+parsedGameId+"/queue/updates")
            }
        }
        document.addEventListener("DOMContentLoaded", () => {
            setTimeout(connectWebsocket, 1000);
            setTimeout(getAllMessages, 1000);
        });

        $(document).ready(function() {
            updateButtonText(isJoined);

            $("#sendMessageButton").click(function() {
                var message = $("#message").val();

                $.ajax({
                    type: "POST",
                    url: "/game/sendMessage",
                    data: {
                        gameId: parsedGameId,
                        message: message,
                        [header]: token
                    },
                    success: function(data) {
                        console.log("Message sent successfully");
                        $("#message").val(""); // Clear the textbox
                        // Optionally update the message board with the new message
                        getAllMessages();
                    },
                    error: function(xhr, status, error) {
                        console.error("Error sending message: " + xhr.statusText);
                    }
                });
            });
        });

        function joinOrLeaveGame() {
            var url = isJoined ? "/game/leave" : "/game/join";
            
            $.ajax({
                type: "POST",
                url: url,
                data: { 
                    gameId: parsedGameId,
                    [header]: token
                },
                success: function(data) {
                    // Handle success
                    isJoined = !isJoined; // Toggle join status
                    updateButtonText(isJoined);
                },
                error: function(xhr, status, error) {
                    // Handle error
                }
            });
            
            if (!isJoined) {
                ws.subscribe("/game/"+parsedGameId+"/queue/updates")
            }
            else {
                ws.stompClient.unsubscribe("/game/"+parsedGameId+"/queue/updates")
            }
        }

        function getAllMessages() {
            $.ajax({
                type: "GET",
                url: "/game/received",
                data: { 
                    gameId: parsedGameId,
                    [header]: token
                },
                success: function(data) {
                    // Handle success
                    console.log("Received the following messages:");
                    cleanMessageBoard();
                    data.forEach(function(message) {
                        console.log("From:", message.from);
                        console.log("To:", message.to);
                        console.log("Sent:", message.sent);
                        console.log("Received:", message.received);
                        console.log("Text:", message.text);
                        console.log("ID:", message.id);
                        console.log("---");
                        
                        
                        var messageDiv = createMessageHTML(message);
                        updateMessageBoard(messageDiv);
                        // var messageDiv =
                        // <div th:fragment="div(message)" class="messageContainer">
                        //     <img alt="User Profile Picture" class="profilePicture" src="img/gatoque.jpg" th:src="@{message.user.profilePicture}"/>
                        //         <div class="text">
                        //             <p th:text="${message.user.name}" class="username" >Mamertín</p>
                        //             <p th:text="${message.text}" class="messageText">Una mamertada, probablemente</p>
                        //         </div>
                        // </div>
                        // ;
                    });
                },
                error: function(xhr, status, error) {
                    // Handle error
                }
            });
        }


        function updateButtonText(isJoined) {
            if (isJoined) {
                $(".messageBoard").show();
                getAllMessages();
                var buttonText = "Salir de la partida";
            }
            else {
                $(".messageBoard").hide();
                var buttonText = "Unirte a la partida";
            }
            $("#joinLeaveButton").text(buttonText);
        }

        function createMessageHTML(messageData){
            var messageDiv = document.createElement("div");
            messageDiv.classList.add("messageContainer");

            var profilePicture = document.createElement("img");
            profilePicture.setAttribute("alt", "User Profile Picture");
            profilePicture.classList.add("profilePicture");
            profilePicture.setAttribute("src", "img/gatoque.jpg"); // This line might need adjustment based on your project structure
            // Set the 'th:src' attribute if needed in your context
            // profilePicture.setAttribute("th:src", "@{message.user.profilePicture}");

            var textDiv = document.createElement("div");
            textDiv.classList.add("text");

            var username = document.createElement("p");
            username.classList.add("username");
            // Assuming 'message' is available in your context
            username.textContent = messageData.from;
            // If you're using Thymeleaf, you might need to use th:text in your HTML template instead
            username.setAttribute("th:text", "${message.user.name}");

            var messageText = document.createElement("p");
            messageText.classList.add("messageText");
            // Assuming 'message' is available in your context
            messageText.textContent = messageData.text;
            // If you're using Thymeleaf, you might need to use th:text in your HTML template instead
            messageText.setAttribute("th:text", "${message.text}");

            textDiv.appendChild(username);
            textDiv.appendChild(messageText);

            messageDiv.appendChild(profilePicture);
            messageDiv.appendChild(textDiv);

            return messageDiv;

        }

        function updateMessageBoard(message) {
            $(".messageBoard").append(message);
        }

        function cleanMessageBoard() {
            $(".messageBoard").empty();
        }
    </script>
    

</body>

</html>